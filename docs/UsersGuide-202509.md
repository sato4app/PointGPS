# PointGPS 利用者の手引（2024年9月版）

## はじめに

PointGPSは、国土地理院地図上でGPSポイントを簡単に管理できるWebアプリケーションです。最新版（v2.1）では統合ボタンUIを採用し、より直感的で使いやすいインターフェースを実現しています。このガイドでは、初心者から上級者まで、効率的にアプリを使用する方法を説明します。

## 目次

1. [セットアップ](#セットアップ)
2. [基本操作](#基本操作)
3. [データの読み込み](#データの読み込み)
4. [ポイント操作](#ポイント操作)
5. [データの出力](#データの出力)
6. [高度な機能](#高度な機能)
7. [トラブルシューティング](#トラブルシューティング)
8. [よくある質問](#よくある質問)

## セットアップ

### 動作環境
- **ブラウザ**: Chrome 90+、Firefox 88+、Safari 14+、Edge 90+（最新版推奨）
- **ネットワーク**: インターネット接続必須（地図データ・標高API取得のため）
- **ローカルサーバー**: ファイル読み込みにはローカルサーバーが必要

### 起動方法
1. **ローカルサーバーを起動**
   ```bash
   # Pythonを使用
   python -m http.server 8000
   
   # またはnpm serveを使用
   npx serve .
   ```

2. **ブラウザでアクセス**
   - `http://localhost:8000` を開く
   - PointGPSアプリが表示されます

### 初回起動時の確認事項
- 地図が正常に表示される
- 右側に操作パネルが表示される
- 初期地図位置が箕面大滝周辺（大阪府）に設定される

## 基本操作

### 画面構成
- **地図エリア**: メインの地図表示（画面全体）
- **操作パネル**: ポイント編集ツール（右上固定、320px幅）
- **メッセージエリア**: 操作結果の通知（画面中央ポップアップ）

### 地図操作
- **ズーム**: マウスホイール、またはズームボタン（右下の+/-）
- **パン**: 地図をドラッグして移動
- **スケール**: 右下にメートル単位のスケールバー表示

### 基本的な操作の流れ
1. **データ読み込み** → 統合読み込みボタンで形式を選択してファイルを読み込む
2. **ポイント表示確認** → 地図上にポイントが表示される
3. **ポイント選択・編集** → 必要に応じて情報を編集
4. **データ出力** → 統合出力ボタンで形式を選択してファイルを保存

## データの読み込み

### 統合読み込みインターフェース

**v2.1の新機能**: 読み込み機能が統合され、より使いやすくなりました。

1. **「ポイント読み込み」ボタン（160px幅）** - 左側に配置
2. **ファイル形式選択ラジオボタン** - 右側に縦配置
   - **Excel** (デフォルト選択)
   - **GeoJSON**

### Excelファイルの読み込み

1. **ラジオボタンで「Excel」を選択**（デフォルトで選択済み）
2. **「ポイント読み込み」ボタンをクリック**
3. **Excelファイル(.xlsx)を選択**
4. **ファイル形式の要件**:
   - **拡張子**: .xlsxのみ対応
   - **必要列**:
     - ポイントID列: "ポイント"を含む列名（例：ポイントID、ポイント番号）
     - 緯度列: "緯度"完全一致
     - 経度列: "経度"完全一致
     - 標高列: "標高"完全一致（オプション）
     - 場所名列: "名称"、"位置"、"場所"のいずれかを含む列名
   - **座標データ**: 10進数形式または度分秒形式

5. **読み込み結果**:
   - 成功時: ポイントが地図上に緑色の円マーカーで表示
   - ポイント数がカウンター表示
   - 成功メッセージが3秒間表示

### GeoJSONファイルの読み込み

1. **ラジオボタンで「GeoJSON」を選択**
2. **「ポイント読み込み」ボタンをクリック**
3. **GeoJSONファイル(.geojson)を選択**
4. **対応形式**:
   - FeatureCollection形式
   - Point geometry
   - 座標配列: [経度, 緯度, 標高]
   - プロパティ: id, name などの属性情報

### 座標変換機能

アプリケーションは以下の座標形式を自動認識・変換します：

- **度分秒形式 → 10進数変換**
  - `35°30'45"N` → `35.5125`
  - `35度30分45秒N` → `35.5125`
  - `E135°28'19.35"` → `135.472041`

### 読み込み時の注意事項
- **大容量ファイル**: Excel 10MB、GeoJSON 5MB程度まで推奨
- **データ検証**: 不正なデータは自動的にスキップ
- **エラー処理**: 空行や不正座標値は無視されます
- **ファイル形式選択**: 必ず対象ファイルに対応するラジオボタンを選択してください

### 統合UIの利点

**v2.1の統合ボタンUIにより以下が改善されました**:
- **操作ミス削減**: ラジオボタンによる明確な形式選択
- **画面スペース効率化**: 160px固定幅による統一感
- **直感的操作**: 1つのボタンで複数形式に対応
- **視認性向上**: ラジオボタンの縦配置で選択状況が明確

**💡 使用のヒント**: 
- 読み込み前に必ずラジオボタンで正しいファイル形式を選択
- デフォルトはExcel形式で、最もよく使われる形式
- 大量ポイントデータはExcel形式がおすすめ
- GIS連携にはGeoJSON形式が適している

**📸 スクリーンショット推奨箇所**:
- 統合読み込みUI（ボタン+ラジオボタン配置）
- 統合出力UI（ボタン+ラジオボタン配置）
- ラジオボタン選択状態の表示

## ポイント操作

### ポイント追加

1. **「追加」ボタンをクリック**
2. **カーソルがクロスヘア（十字）に変化**
3. **地図上の任意の場所をクリック**
4. **新しいポイントが追加され、自動選択される**
5. **自動的にポイントIDフィールドがフォーカス・全選択される**

**新規ポイントの特徴**:
- **自動ID**: 仮01, 仮02... の連番で自動割り当て
- **自動標高取得**: 国土地理院標高APIから自動取得
- **即座に編集可能**: ポイントIDが全選択状態で編集しやすい

**💡 Tips**: 
- ESCキーで追加モードを終了
- 追加完了後は自動的にモード解除
- 新規ポイント追加後はTabキーでスムーズに名称編集へ移行可能

**📸 スクリーンショット推奨箇所**:
- 追加モード時のクロスヘアカーソル表示
- 新規ポイント追加直後のID全選択状態
- 自動標高取得完了時のフィールド表示

### ポイント選択

1. **地図上のポイント（緑色の円）をクリック**
2. **選択されたポイントはライムグリーン（#32cd32）に変化**
3. **右側パネルにポイント情報が表示**
4. **GPS標高が未設定の場合、自動取得される**

### ポイント移動

1. **移動したいポイントを選択**
2. **「移動」ボタンをクリック**
   - ボタンがライムグリーン（#32cd32）に変化
   - カーソルが移動カーソルに変化
3. **選択されたポイントをドラッグして移動**
   - **リアルタイム更新**: ドラッグ中に緯度・経度・DMS座標が動的に更新
   - 移動中は座標情報が常に最新値に更新
4. **ドロップ時に移動完了**
   - GPS標高が自動再取得
   - 移動モードが自動解除
   - 移動完了メッセージが表示

**移動モードの自動解除条件**:
- ドラッグ完了時（自動）
- 他のポイントをクリック
- 「追加」「削除」ボタンをクリック
- ESCキーを押下

**💡 移動操作のコツ**:
- 移動ボタンがライムグリーンになったことを確認してからドラッグ開始
- リアルタイム座標更新を見ながら正確な位置調整が可能
- 移動中はGPS標高も自動更新されるため、地形情報も把握できる

**📸 スクリーンショット推奨箇所**:
- 移動ボタンのライムグリーン化状態
- ドラッグ中のリアルタイム座標更新表示
- 移動カーソル表示状態

### ポイント削除

1. **削除したいポイントを選択**
2. **「削除」ボタンをクリック**
3. **確認ダイアログで「OK」をクリック**
4. **ポイントが地図とデータから完全削除**

### ポイント情報編集

選択されたポイントの情報は右側パネルで確認・編集できます：

| フィールド | 編集可否 | 説明 |
|------------|----------|------|
| **ポイントID** | ✅ 編集可能 | 最大5文字、自動フォーマット機能付き |
| **緯度** | ❌ 読み取り専用 | 10進数5桁表示、リアルタイム更新 |
| **経度** | ❌ 読み取り専用 | 10進数5桁表示、リアルタイム更新 |
| **DMS** | ❌ 読み取り専用 | 度分秒形式、E/N方向表示付き |
| **標高** | ❌ 読み取り専用 | 手動編集不可、GPS標高値を表示 |
| **GPS標高** | ❌ 読み取り専用 | 国土地理院API自動取得 |
| **名称** | ✅ 編集可能 | 最大20文字、場所名や説明 |

### タブ操作（キーボード操作）

効率的な編集のため、以下のタブ順序が設定されています：

1. **ポイントID** (tabindex="1") → Tab押下 → **名称** (tabindex="2")
2. 読み取り専用フィールド（緯度、経度、DMS、標高、GPS標高）はタブでスキップ (tabindex="-1")

**💡 キーボード効率化のヒント**:
- 新規ポイント追加後、自動でポイントIDにフォーカス＆全選択される
- 必要に応じてそのまま入力してIDを変更、またはTabで名称へ
- 読み取り専用フィールドはタブが当たらないため高速編集が可能

### ポイントID自動フォーマット

ポイントIDは以下のルールで自動正規化されます：

- **全角→半角変換**: ３ → 3
- **小文字→大文字変換**: p → P
- **0パディング**: 1 → 01
- **ハイフン自動挿入**: P01 → P-01
- **日本語文字**: そのまま保持

## データの出力

### 統合出力インターフェース

**v2.1の新機能**: 出力機能が統合され、ファイル形式をラジオボタンで簡単に選択できます。

1. **「ポイント出力」ボタン（160px幅）** - 左側に配置
2. **出力形式選択ラジオボタン** - 右側に縦配置
   - **Excel** (デフォルト選択)
   - **GeoJSON**

### Excel形式で出力

1. **ラジオボタンで「Excel」を選択**（デフォルトで選択済み）
2. **「ポイント出力」ボタンをクリック**
3. **保存ダイアログでファイル名・場所を指定**
4. **全ポイント情報が.xlsx形式で保存**

**出力内容**:
- **ヘッダー行**: ID, 緯度, 経度, 標高, GPS標高, 場所
- **デフォルトファイル名**: `ポイントGPS-yyyymmdd.xlsx`

### GeoJSON形式で出力

1. **ラジオボタンで「GeoJSON」を選択**
2. **「ポイント出力」ボタンをクリック**
3. **保存ダイアログでファイル名・場所を指定**
4. **全ポイント情報が.geojson形式で保存**

**出力特徴**:
- **形式**: FeatureCollection
- **座標**: [経度, 緯度, 標高]順
- **標高優先順**: GPS標高 > 手動入力標高
- **プロパティ**: id, name属性
- **デフォルトファイル名**: `ポイントGPS-yyyymmdd.geojson`

### ファイル保存方式

- **File System Access API対応ブラウザ（Chrome系）**: 直接保存ダイアログ
- **未対応ブラウザ**: 自動ダウンロード方式

## 高度な機能

### GPS標高の自動取得

**データソース**: 国土地理院標高API（5mメッシュ、レーザー測量データ）

**取得タイミング**:
- ポイント新規追加時（自動）
- ポイント選択時（GPS標高未設定の場合のみ）
- ポイント移動完了時（強制再取得）

**処理仕様**:
- **数値処理**: 四捨五入による整数化
- **エラー処理**: API障害時は警告ログ出力、処理継続
- **表示**: GPS標高フィールドに自動表示

### リアルタイム座標更新

移動モード中は以下の情報がリアルタイム更新されます：

- **緯度・経度**: 10進数5桁表示
- **DMS座標**: 度分秒形式（東経・北緯順）
- **ポイントマーカー位置**: ドラッグ中の即座の反映

### 色とビジュアルフィードバック

**マーカー色**:
- **通常ポイント**: 緑色（#008000）
- **選択ポイント**: ライムグリーン（#32cd32）

**ボタン色**:
- **通常ボタン**: 青色（#3498db）
- **移動モード活性**: ライムグリーン（#32cd32）
- **エクスポートボタン**: オレンジ色（#e67e22）

**カーソル変更**:
- **追加モード**: 十字カーソル
- **移動モード**: 移動カーソル

### レスポンシブ対応

**デスクトップ（1024px以上）**:
- 右側固定操作パネル（320px幅）
- 全機能利用可能

**タブレット（768px〜1023px）**:
- 操作パネル全幅表示
- タッチ操作対応

**モバイル（767px以下）**:
- レイアウト最適化
- ボタン縦配置
- タッチ操作最適化

## トラブルシューティング

### よくあるエラーと対処法

#### 「ファイルが読み込めません」
**原因**: 
- ファイル形式と選択したラジオボタンが異なる
- ファイル形式不正（.xlsx/.geojson以外）
- ファイル破損
- 必要列の不足

**対処法**: 
- ファイル形式とラジオボタンの選択が一致しているか確認
- ファイル形式を確認（.xlsx/.geojson形式か？）
- 必要な列（ポイント、緯度、経度）が含まれているか確認
- 別のファイルで試行

#### 「地図が表示されません」
**原因**: 
- インターネット接続問題
- CDN読み込み失敗

**対処法**: 
- インターネット接続を確認
- ページを再読み込み（F5キー）
- ブラウザキャッシュをクリア

#### 「ポイントをドラッグできません」
**原因**: 
- 移動モードが有効でない
- 別のポイントが選択されている

**対処法**: 
- 移動したいポイントを選択
- 「移動」ボタンをクリック
- ボタンがライムグリーンに変化することを確認

#### 「GPS標高が取得できません」
**原因**: 
- 国土地理院API接続エラー
- 対象地域外（日本国外）
- 一時的なサーバー障害

**対処法**: 
- しばらく待ってから再試行
- 日本国内の座標か確認
- コンソールログでエラー詳細を確認

#### 「ローカルサーバーエラー」
**原因**: 
- CORS制限（file://プロトコル使用）
- サーバー未起動

**対処法**: 
- 必ずHTTPサーバー経由でアクセス
- `python -m http.server 8000` を実行
- `http://localhost:8000` でアクセス

### パフォーマンスの最適化

#### 大量ポイントでの動作が重い場合
1. **ブラウザメモリクリア**: 不要なタブを閉じる
2. **ポイント数調整**: 1000点程度に分割
3. **ズームレベル調整**: 必要以上に詳細表示しない

#### 地図表示が遅い場合
1. **ネットワーク速度確認**: 高速回線推奨
2. **ブラウザ最適化**: 最新版使用、拡張機能無効化
3. **キャッシュクリア**: 定期的なブラウザキャッシュクリア

## よくある質問

### Q: 対応しているファイル形式は？
**A**: 入力は.xlsxと.geojson、出力は.xlsxと.geojsonに対応しています。v2.1では統合ボタンUI採用により、ラジオボタンで形式を選択します。.xlsファイルや.csvファイルは直接対応していません。

### Q: 最大何個のポイントを扱えますか？
**A**: 技術的な上限はありませんが、ブラウザのメモリに依存します。実用的には1000点程度まで快適に動作します。それ以上の場合は分割することを推奨します。

### Q: オフラインで使用できますか？
**A**: 地図表示と標高取得にはインターネット接続が必要です。ポイント編集などの基本機能は接続なしでも部分的に動作しますが、推奨しません。

### Q: スマートフォンで使用できますか？
**A**: はい。レスポンシブデザインによりタッチ操作に対応しており、スマートフォンやタブレットでも使用可能です。ただし、画面サイズの制約により一部機能は制限される場合があります。

### Q: データのバックアップは？
**A**: アプリケーションはデータを永続化しないため、定期的にExcelまたはGeoJSON形式でエクスポートすることを強く推奨します。

### Q: 座標系は何を使用していますか？
**A**: WGS84（世界測地系）の緯度経度座標系を使用しています。日本測地系（Tokyo Datum）には対応していません。

### Q: 商用利用は可能ですか？
**A**: アプリケーション自体のライセンス条項および国土地理院地図タイルの利用規約に準拠する必要があります。詳細はライセンス文書を確認してください。

### Q: ポイントIDに日本語は使えますか？
**A**: はい。ポイントIDには日本語文字も使用可能です。自動フォーマット機能は英数字のみに適用され、日本語文字はそのまま保持されます。

### Q: 移動中に座標が表示されるのは便利ですが、更新頻度は？
**A**: ドラッグ中はmousemoveイベントに同期してリアルタイム更新されます。非常に高頻度（通常60fps程度）で更新されるため、滑らかな座標変化が確認できます。

### Q: GPS標高と手動入力標高の違いは？
**A**: 
- **GPS標高**: 国土地理院の5mメッシュレーザー測量データから自動取得（精度高）
- **手動標高**: 現在のバージョンでは手動編集不可（将来機能として検討中）

## サポート情報

### 技術サポート
- **詳細仕様**: `docs/funcspec.md` 参照
- **ソースコード**: JavaScript ES6 modules構成
- **開発環境**: ローカルHTTPサーバーでの動作必須
- **CLAUDE.md**: 開発者向け詳細情報

### システム要件
- **CPU**: 1GHz以上推奨
- **メモリ**: 2GB以上推奨
- **ストレージ**: 特に制限なし（ブラウザ一時領域のみ使用）
- **ネットワーク**: 常時接続推奨

### アップデート情報
- **更新頻度**: 機能追加、バグ修正に応じて随時
- **後方互換性**: データファイル形式の互換性維持
- **変更履歴**: 各ドキュメント内の更新履歴を参照

### セキュリティ
- **データ処理**: 完全ローカル処理（サーバー送信なし）
- **外部通信**: 地図タイル、標高API（HTTPS）のみ
- **プライバシー**: 位置情報は明示的入力のみ、自動収集なし

---

---

## v2.1の主な新機能・改善点

### 統合ボタンUI
- **読み込み機能統合**: 「ポイント読み込み」ボタン + ファイル形式ラジオボタン
- **出力機能統合**: 「ポイント出力」ボタン + 出力形式ラジオボタン  
- **デザイン統一**: 全ボタン160px固定幅で視覚的統一感を実現
- **操作性向上**: 1ボタン複数形式対応により操作ミスを削減

### UX改善
- **タブ順序制御**: 効率的なキーボード操作（ポイントID→名称の論理的順序）
- **自動フォーカス**: 新規ポイント追加時のID全選択による編集効率化
- **リアルタイム更新**: 移動中の座標情報動的表示
- **視覚フィードバック強化**: ボタン色変化とカーソル変更の改良

### データ管理強化  
- **標高フィールド読み取り専用化**: データ整合性とAPI連携の改善
- **色設定統一**: CONFIG.jsによる一元管理でメンテナンス性向上
- **エラーハンドリング改善**: より詳細なユーザー向けエラーメッセージ

---

**最終更新**: 2024年9月6日  
**バージョン**: v2.1  
**対応ブラウザ**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

**© 2024 PointGPS Development Team. All rights reserved.**