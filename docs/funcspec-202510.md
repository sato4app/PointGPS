# PointGPS 機能仕様書

**バージョン**: 2.0
**最終更新日**: 2025年10月27日
**作成者**: PointGPS Development Team

---

## 目次

1. [概要](#概要)
2. [システム構成](#システム構成)
3. [主要機能](#主要機能)
4. [データ構造](#データ構造)
5. [UI/UX仕様](#uiux仕様)
6. [技術仕様](#技術仕様)
7. [セキュリティ](#セキュリティ)
8. [制約事項](#制約事項)
9. [バージョン履歴](#バージョン履歴)

---

## 概要

### プロジェクト名
**PointGPS**

### 目的
国土地理院地図上でGPSポイントの表示、編集、管理を行うWebアプリケーション。
Excel専用化により30-50倍の大幅高速化を実現し、厳密なデータ検証機能とフィールド配置の最適化を提供。

### 対象ユーザー
- ハイキング、トレッキング、登山などの活動でGPSポイントを記録・管理する利用者
- 地理情報を扱う研究者、調査員
- 観光スポット、名所の位置情報を管理する事業者

### 主な特徴
- **Excel専用化**: GeoJSON廃止による30-50倍の高速化（100ポイント約300-500ms）
- **リアルタイム編集**: ドラッグ操作でポイント位置をリアルタイム移動
- **自動標高取得**: 国土地理院標高APIとの連携
- **重複防止機能**: 同一位置への重複ポイント追加を防止
- **データ検証**: ポイントID自動フォーマット、座標変換、必須項目チェック
- **レスポンシブ対応**: デスクトップ、タブレット、モバイルに対応

---

## システム構成

### アーキテクチャ
ES6モジュール構成で、機能別にファイルが分離された構造。

### モジュール一覧

#### メインアプリケーション
- **PointGPSApp** (`js/app.js`)
  - 全モジュールを統合・管理するメインクラス
  - イベントハンドラーの設定
  - メッセージ表示制御

#### コアモジュール
- **MapManager** (`js/map-manager.js`)
  - Leaflet地図の初期化・設定管理
  - 国土地理院タイルレイヤー管理
  - ズーム・スケールコントロール配置

- **GPSDataManager** (`js/gps-data-manager.js`)
  - Excelファイルからのデータ読み込み・解析
  - ポイントデータの追加・更新・削除
  - データ検証（必須項目、座標範囲チェック）
  - Excelファイル出力処理

- **PointManager** (`js/point-manager.js`)
  - 地図上のマーカー表示・管理
  - ポイント選択・追加・移動・削除
  - リアルタイム座標更新
  - 重複チェック機能
  - ドラッグ操作制御

- **FileHandler** (`js/file-handler.js`)
  - Excelファイル入出力処理
  - File System Access API対応
  - 列幅自動調整（日本語対応）

#### ユーティリティモジュール
- **DataUtils** (`js/data-utils.js`)
  - ポイントID正規化（全角→半角、大文字化、0パディング）
  - 座標変換（DMS ⇔ 10進数）
  - 標高正規化
  - データバリデーション

- **ElevationAPI** (`js/elevation-api.js`)
  - 国土地理院標高API連携
  - 標高取得条件判定
  - エラーハンドリング

#### 設定
- **CONFIG** (`js/config.js`)
  - アプリケーション全体の設定定数
  - 地図設定（中心座標、ズームレベル）
  - マーカー色設定
  - メッセージテンプレート
  - 重複チェック距離設定

---

## 主要機能

### 1. データ読み込み機能（Excel専用）

#### 機能概要
Excelファイル（.xlsx形式）からGPSポイントデータを読み込む。

#### 仕様
- **対応形式**: Excel (.xlsx) のみ
- **最大行数**: 1,000行（`CONFIG.MAX_EXCEL_ROWS`）
- **処理速度**: 100ポイント約300-500ms（30-50倍高速化）
- **厳密な列名一致判定**: 完全一致のみ受付

#### 必須列
- `ポイントID`: ポイント識別子
- `名称`: 場所名
- `緯度`: 緯度（10進数またはDMS形式）
- `経度`: 経度（10進数またはDMS形式）

#### 任意列
- `標高`: 標高値（メートル）
- `備考`: 備考情報

#### 座標変換
- **DMS形式**: `34°51'13.2"N` → 10進数 `34.853667`
- **自動変換**: 度分秒形式を自動的に10進数に変換

#### データ検証
- 必須項目欠け行の自動スキップ
- 座標値範囲チェック（NaN判定）
- 空行の自動除外

#### エラーハンドリング
- 列名不一致時のエラーメッセージ表示
- ファイル読み込み失敗時の警告

---

### 2. ポイント表示機能

#### マーカー設定
- **形状**: 円形マーカー（CircleMarker）
- **半径**: 6ピクセル（`CONFIG.POINT_MARKER_RADIUS`）
- **通常色**: 緑 `#008000` (`CONFIG.POINT_MARKER_COLOR`)
- **選択時**: ライムグリーン `#32cd32` (`CONFIG.SELECTED_POINT_COLOR`)
  - 線の太さ: 3px
  - 不透明度: 0.9

#### ツールチップ
- **表示内容**: ポイントID
- **表示位置**: マーカーの上部
- **表示タイミング**: マウスホバー時

#### ポイント数表示
- **表示場所**: パネル上部
- **フォーマット**: `{数値}個`
- **テキスト配置**: 右寄せ

---

### 3. ポイント追加機能

#### 操作フロー
1. 「追加」ボタンをクリック
2. 地図上の任意の位置をクリック
3. 新規ポイントが追加され、自動選択される
4. ポイントIDフィールドが自動フォーカス・全選択される

#### 仮ID生成
- **形式**: `仮01`, `仮02`, ...
- **自動採番**: 既存の仮IDを確認し、欠番を埋める

#### 重複チェック
- **判定距離**: 10ピクセル以内（`CONFIG.DUPLICATE_CHECK_DISTANCE`）
- **カーソル変化**:
  - 既存ポイント付近: 禁止マーク（`not-allowed`）
  - それ以外: 十字カーソル（`crosshair`）
- **警告メッセージ**: `既存のポイント {id} と同じ場所には追加できません`

#### 標高自動取得
- 新規追加時に国土地理院標高APIから自動取得
- 小数点1位まで表示（123.0は123として表示）

---

### 4. ポイント移動機能

#### 操作フロー
1. 移動したいポイントを選択
2. 「移動」ボタンをクリック
3. マーカーをドラッグして位置変更
4. ドロップすると新しい位置が確定

#### ビジュアルフィードバック
- **移動ボタン**: ライムグリーン（`#32cd32`）に変化
- **カーソル変化**:
  - ドラッグ可能時: `move`
  - ドラッグ中: `grabbing`

#### リアルタイム更新
- ドラッグ中に緯度・経度・DMSがリアルタイム表示
- `mousemove`イベント同期の高頻度更新

#### 移動完了時の処理
- GPS標高の強制再取得
- ポイント位置情報の更新
- 移動モードの自動解除
- 移動ボタン色のリセット

#### 自動モード解除
- ドラッグ完了時
- ESCキー押下時
- 他のポイントクリック時
- 他のボタン操作時

---

### 5. ポイント削除機能

#### 操作フロー
1. 削除したいポイントを選択
2. 「削除」ボタンをクリック
3. 確認ダイアログで確認
4. OKで削除実行

#### 確認ダイアログ
- **表示内容**: `選択したポイント {id} を削除しますか？`
- **ボタン**: OK / キャンセル

#### 削除後の処理
- マーカーの地図からの削除
- データからの削除
- 選択状態のクリア
- ポイント情報表示のクリア
- ポイント数表示の更新

---

### 6. ポイント情報編集機能

#### 編集可能フィールド
- **ポイントID** (`pointIdField`)
  - 自動フォーマット機能
  - 最大5文字
  - タブ順序: 1

- **名称** (`locationField`)
  - 場所名入力
  - 最大20文字
  - タブ順序: 2

- **備考** (`remarksField`)
  - 自由記述
  - 最大50文字
  - タブ順序: 3

#### 読み取り専用フィールド
- **緯度** (`latDecimalField`)
  - 10進数形式
  - 小数点以下5桁
  - テキスト配置: 右寄せ
  - タブスキップ（`tabindex="-1"`）

- **経度** (`lngDecimalField`)
  - 10進数形式
  - 小数点以下5桁
  - テキスト配置: 右寄せ
  - タブスキップ（`tabindex="-1"`）

- **DMS** (`dmsField`)
  - 度分秒形式
  - フォーマット: `{経度} {緯度}` (E/N方向付き)
  - 例: `135°28'19.35"E 34°51'13.20"N`
  - テキスト配置: 中央寄せ
  - タブスキップ（`tabindex="-1"`）

- **標高** (`elevationField`)
  - GPS標高（国土地理院API取得）
  - 小数点1位まで
  - 単位: m
  - テキスト配置: 右寄せ
  - タブスキップ（`tabindex="-1"`）

#### ポイントID自動フォーマット
- **全角→半角変換**: 英数字、ハイフン
- **大文字化**: 英文字を大文字に統一
- **0パディング**: 末尾1桁数字を2桁に（例: `P1` → `P01`）
- **ハイフン挿入**: 3文字以下で数字の前に挿入（例: `P01` → `P-01`）
- **日本語保持**: 漢字・ひらがな・カタカナはそのまま保持

#### 変更検知と更新
- `change`イベントで自動保存
- ポイントID変更時はマーカーのマップとツールチップを更新

---

### 7. Excel出力機能

#### 機能概要
現在のポイントデータをExcel形式で出力する。

#### 出力仕様
- **ファイル形式**: Excel (.xlsx)
- **シート名**: `ポイントGPS`
- **デフォルトファイル名**: `ポイントGPS-yyyymmdd.xlsx`
- **保存方式**: File System Access API優先、フォールバック自動ダウンロード

#### 出力内容
| 列名 | データ型 | 精度 | 備考 |
|------|---------|------|------|
| ポイントID | 文字列 | - | そのまま出力 |
| 名称 | 文字列 | - | そのまま出力 |
| 緯度 | 数値 | 小数点以下5桁 | `parseFloat`で数値化 |
| 経度 | 数値 | 小数点以下5桁 | `parseFloat`で数値化 |
| 標高 | 数値 | 小数点1位まで | 数値型で出力 |
| 備考 | 文字列 | - | そのまま出力 |

#### 列幅自動調整
- 日本語対応（1文字=2幅として計算）
- 最小幅: 8
- 最大幅: 50
- パディング: +2

#### ファイル保存
- **File System Access API対応ブラウザ**: ダイアログで保存場所を選択
- **非対応ブラウザ**: 自動ダウンロード

---

### 8. 国土地理院標高API連携

#### API仕様
- **エンドポイント**: `https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php`
- **パラメータ**: `lon={経度}&lat={緯度}&outtype=JSON`
- **測量方式**: 5mメッシュ、レーザー測量データ

#### 取得タイミング
- **新規ポイント追加時**: 自動取得
- **ポイント選択時**: blank または 0 の場合のみ取得
- **ポイント移動完了時**: 強制再取得
- **Excel読み込み時**: 取得しない（高速化のため）

#### 取得条件
- 標高が空文字（`''`）の場合
- 標高が `0` の場合
- 標高が `blank` の場合

#### エラーハンドリング
- API通信失敗時: コンソール警告ログ出力
- 取得失敗時: 既存値を保持

---

## データ構造

### 内部ポイントオブジェクト

```javascript
{
  id: string,        // ポイントID（例: "P-01", "仮01"）
  lat: number,       // 緯度（10進数）
  lng: number,       // 経度（10進数）
  elevation: string, // 標高（API取得値、小数点1位まで）
  location: string,  // 名称（場所名）
  remarks: string    // 備考
}
```

### Excel入力形式

#### ヘッダー行（完全一致必須）
```
| ポイントID | 名称 | 緯度 | 経度 | 標高 | 備考 |
```

#### データ例
```
| ポイントID | 名称     | 緯度      | 経度       | 標高 | 備考           |
|-----------|----------|-----------|------------|------|----------------|
| P-01      | 箕面大滝 | 34.853667 | 135.472041 | 150  | 観光名所       |
```

### Excel出力形式

#### シート構成
- **シート名**: `ポイントGPS`
- **列幅**: 自動調整（日本語対応）
- **座標精度**: 緯度・経度は小数点以下5桁、標高は数値型

#### 出力例
```
| ポイントID | 名称    | 緯度       | 経度        | 標高 | 備考           |
|----------|---------|-----------|-------------|------|----------------|
| P-01     | 箕面大滝 | 34.85367  | 135.47204   | 150  | 観光名所       |
```

---

## UI/UX仕様

### レイアウト

#### デスクトップ（1024px以上）
- 地図: 全画面表示
- コントロールパネル: 右側固定（幅300px）

#### タブレット（768px-1023px）
- 地図: 全画面表示
- コントロールパネル: 全幅表示

#### モバイル（767px以下）
- 地図: 全画面表示
- コントロールパネル: レイアウト最適化

### タブ順序制御
1. ポイントID
2. 名称
3. 備考
4. （読み取り専用フィールドはスキップ）

### カーソル制御

| モード | 状態 | カーソル |
|--------|------|----------|
| 通常 | デフォルト | `default` |
| 追加モード | 通常位置 | `crosshair` |
| 追加モード | 既存ポイント付近 | `not-allowed` |
| 移動モード | ドラッグ可能 | `move` |
| 移動モード | ドラッグ中 | `grabbing` |

### ボタン色変化

| ボタン | 状態 | 背景色 |
|--------|------|--------|
| 追加 | 通常 | デフォルト |
| 追加 | アクティブ | - |
| 移動 | 通常 | デフォルト |
| 移動 | アクティブ | ライムグリーン `#32cd32` |
| 削除 | 通常 | デフォルト |

### メッセージ表示

#### 表示位置
画面上部中央

#### 表示時間
- 通常メッセージ: 3秒（`CONFIG.MESSAGE_DISPLAY_DURATION`）
- 警告メッセージ: 4.5秒（1.5倍）
- エラーメッセージ: 6秒（2倍）

#### メッセージタイプ
- **info**: 通常情報（デフォルト）
- **warning**: 警告（重複チェック等）
- **error**: エラー（ファイル読み込み失敗等）

---

## 技術仕様

### 開発環境

#### 必須ツール
- HTTPサーバー（CORS制限回避のため）
  - Python: `python -m http.server 8000`
  - npm: `npx serve .`

#### 推奨ブラウザ
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### 外部ライブラリ

#### Leaflet.js
- **バージョン**: 1.9.4
- **CDN**: unpkg.com
- **用途**: 地図表示・レンダリング
- **整合性検証**: integrity + crossorigin属性

#### SheetJS (XLSX)
- **バージョン**: 0.18.5
- **CDN**: unpkg.com
- **用途**: Excelファイル読み込み・書き込み

#### 国土地理院タイル
- **URL**: `https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png`
- **最大ズーム**: 18
- **Attribution**: 地理院タイル

### モジュールシステム
- **ES6 Modules**: `type="module"`
- **依存関係管理**: import/export

### 座標系
- **使用座標系**: WGS84
- **入力形式**: 10進数 または DMS（度分秒）
- **内部処理**: 10進数統一

### API連携
- **標高API**: 国土地理院標高API
- **通信方式**: Fetch API
- **エラーハンドリング**: try-catch + console.warn

---

## セキュリティ

### XSS対策
- `innerHTML`の使用回避
- `textContent`の使用推奨
- ユーザー入力のサニタイズ

### CSRF対策
- ローカル処理のみ
- 外部送信なし

### ファイル検証
- MIME typeチェック
- 拡張子検証（.xlsx）
- ファイルサイズ制限（間接的に行数制限）

### CDN整合性検証
- `integrity`属性によるSRI（Subresource Integrity）
- `crossorigin`属性

---

## 制約事項

### 技術制約
- **CORS制限**: `file://`プロトコル不可、HTTPサーバー必須
- **座標系制限**: WGS84のみ対応（日本測地系非対応）
- **ファイル形式**: Excel (.xlsx) のみ対応

### 運用制約
- **インターネット接続**: 地図タイル、標高API利用のため必須
- **メモリ制限**: 大量ポイント（1000点以上）では性能劣化の可能性
- **データ永続化**: ブラウザ一時メモリのみ、定期エクスポート推奨

### ブラウザ制約
- **File System Access API**: 未対応ブラウザでは自動ダウンロード方式
- **ES6 Modules**: 古いブラウザでは動作不可
- **Fetch API**: ポリフィル不要（推奨ブラウザで標準対応）

---

## バージョン履歴

### Version 2.0（2025年10月27日）
- **Excel出力時の標高数値化**: 計算・並べ替え対応
- **テキストフィールド配置最適化**:
  - ポイント数: 右寄せ
  - 緯度・経度・標高: 右寄せ
  - DMS: 中央寄せ
- **重複ポイント追加防止機能**:
  - 10ピクセル以内の重複チェック
  - 警告メッセージ表示
  - カーソル変化（`not-allowed`）
- **ビジュアルフィードバック強化**:
  - マーカー色変化（選択時）
  - ボタン色変化（移動モード時）
  - カーソル変化（追加・移動モード時）

### Version 1.0（2025年9月12日）
- **基準バージョン**: 2025年9月12日をVersion 1.0として設定
- **Excel専用化**: GeoJSON機能削除による30-50倍高速化達成
- **主要機能完成**:
  - Excel (.xlsx) 読み込み・出力専用化
  - リアルタイムポイント移動・編集
  - 国土地理院標高API連携
  - ポイントID自動フォーマット
  - タブ順序最適化
  - レスポンシブデザイン対応
- **モジュール分離完了**:
  - DataUtilsによるデータ処理統合
  - ElevationAPIによるAPI処理独立
  - 保守性・拡張性向上

---

## 今後の開発予定

### 検討中の機能
- 手動標高入力機能の復活
- バッチ処理機能（複数ポイント一括編集）
- ルート描画機能
- データ永続化機能（localStorage対応）
- ポイント検索機能
- フィルタリング機能
- インポート/エクスポート形式の追加（CSV、GeoJSON等）

### パフォーマンス改善
- 大量ポイント（1000点以上）の最適化
- マーカークラスタリング対応
- 仮想スクロール対応

---

**© 2025 PointGPS Development Team. All rights reserved.**
