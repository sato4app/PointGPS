# PointGPS - 機能仕様書

## 概要

PointGPSは、国土地理院地図上でGPSポイントの表示、編集、管理を行うWebアプリケーションです。Excelファイルからのデータ読み込み、ポイントの追加・移動・削除、GeoJSON形式での出力に対応しています。

## システム構成

### アーキテクチャ
- **フレームワーク**: Vanilla JavaScript + ES6 modules
- **地図ライブラリ**: Leaflet.js
- **ファイル処理**: SheetJS
- **座標系**: WGS84（緯度経度）

### モジュール構成
- **PointGPSApp** (`js/app.js`): メインアプリケーション
- **MapManager** (`js/map-manager.js`): 地図管理
- **GPSDataManager** (`js/gps-data-manager.js`): GPSデータ管理
- **PointManager** (`js/point-manager.js`): ポイント表示・編集管理
- **FileHandler** (`js/file-handler.js`): ファイル入出力処理
- **Validators** (`js/validators.js`): データ検証
- **CONFIG** (`js/config.js`): アプリケーション設定

## 主要機能

### 1. 地図表示機能
- **地図タイル**: 国土地理院標準地図
- **初期表示**: 箕面大滝（34.853667, 135.472041）、ズームレベル15
- **最大ズーム**: レベル18
- **コントロール**: ズーム、スケール表示

### 2. データ読み込み機能

#### 2.1 Excelファイル読み込み
- **対応形式**: .xlsx
- **読み込み項目**:
  - ポイントID（文字列、最大5文字）
  - 緯度（数値）
  - 経度（数値）
  - 標高（数値、単位:m）
  - 場所名（文字列、最大20文字）

#### 2.2 GeoJSONファイル読み込み
- **対応形式**: .geojson
- **Feature**: Point geometry

### 3. ポイント表示機能
- **マーカー表示**: 円形マーカー（半径6px、赤色）
- **選択状態**: 緑色に変化
- **ツールチップ**: ポイントID表示
- **ポイント数表示**: リアルタイム更新

### 4. ポイント編集機能

#### 4.1 ポイント追加
- **操作方法**: 追加ボタン → 地図クリック
- **自動割り当て**: 新しいポイントID
- **カーソル変化**: クロスヘア表示

#### 4.2 ポイント移動
- **操作方法**: ポイント選択 → 移動ボタン → ドラッグ
- **UI状態**:
  - 移動ボタン背景色: #32cd32（ライムグリーン）
  - カーソル: grabbing
  - リアルタイム座標更新（緯度・経度・DMS）
- **自動解除条件**:
  - ドラッグ完了時
  - 他のポイントクリック時
  - 他のボタン（追加・削除）クリック時
  - ESCキー押下時
- **GPS標高再取得**: ドラッグ完了時に自動実行

#### 4.3 ポイント削除
- **操作方法**: ポイント選択 → 削除ボタン → 確認ダイアログ
- **確認メッセージ**: 「選択したポイント [ID] を削除しますか？」

### 5. ポイント情報表示・編集

#### 5.1 表示項目
- **ポイントID**: 編集可能（最大5文字、自動フォーマット）
- **緯度**: 10進数形式（5桁精度）、読み取り専用
- **経度**: 10進数形式（5桁精度）、読み取り専用
- **DMS**: 度分秒形式（東経・北緯順、E/N付き）、読み取り専用
- **標高**: 編集可能（最大6文字）
- **GPS標高**: 自動取得、読み取り専用（最大3文字）
- **場所名**: 編集可能（最大20文字）

#### 5.2 GPS標高自動取得
- **取得タイミング**: ポイント選択時、移動完了時
- **API**: 国土地理院標高API
- **条件**: GPS標高が未設定の場合のみ初回取得

### 6. データ出力機能

#### 6.1 Excel出力
- **形式**: .xlsx
- **ファイル名**: デフォルト名 + 日時
- **出力項目**: 全ポイント情報

#### 6.2 GeoJSON出力
- **形式**: .geojson
- **構造**: FeatureCollection with Point features
- **プロパティ**: ポイントID、標高、GPS標高、場所名

### 7. ユーザーインターフェース

#### 7.1 メッセージ表示
- **表示時間**: 3秒（エラーは6秒）
- **種類**: 情報メッセージ、エラーメッセージ
- **位置**: 画面上部オーバーレイ

#### 7.2 キーボードショートカット
- **ESC**: 各種編集モードの終了

#### 7.3 レスポンシブ対応
- **モバイル**: タッチ操作対応
- **デスクトップ**: マウス操作最適化

## 技術仕様

### 座標変換
- **入力**: 度分秒（DMS）
- **内部処理**: 10進数（Decimal Degrees）
- **表示**: 両形式対応

### ファイル形式対応
- **入力**: Excel (.xlsx), GeoJSON (.geojson)
- **出力**: Excel (.xlsx), GeoJSON (.geojson)

### 外部API
- **標高取得**: 国土地理院標高API
- **地図タイル**: 国土地理院地理院タイル

### ブラウザ要件
- **ES6 Modules**: 対応必須
- **Web APIs**: FileReader, Fetch, Blob
- **CORS**: ローカルサーバー必須

## 制約事項

### 技術制約
- **CORS制限**: file://プロトコルでは動作不可
- **ファイルサイズ**: Excelファイルはメモリ制限により大容量ファイル非対応
- **ブラウザ互換**: モダンブラウザのみ対応

### 機能制約
- **最大ズーム**: レベル18（地理院タイル制限）
- **ポイント数**: 実用上の制限なし（メモリ依存）
- **同時編集**: 非対応（単一ユーザー想定）

## エラーハンドリング

### ファイル読み込みエラー
- 形式不正、ファイル破損の検出
- ユーザーフレンドリーなエラーメッセージ

### ネットワークエラー
- API通信失敗時の適切な処理
- オフライン時の基本機能維持

### データ検証
- ポイントID重複チェック
- 座標値範囲検証
- 入力値形式検証

## パフォーマンス

### 最適化項目
- **地図描画**: Leaflet最適化設定
- **大量ポイント**: 効率的なマーカー管理
- **メモリ使用**: 不要オブジェクトの適切な解放

### 推奨動作環境
- **CPU**: 1GHz以上
- **メモリ**: 2GB以上
- **ネットワーク**: 地図タイル読み込み用