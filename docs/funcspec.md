# PointGPS 機能仕様書

## バージョン情報
- **作成日**: 2024年9月1日
- **更新日**: 2024年9月6日  
- **バージョン**: v2.0
- **作成者**: PointGPS開発チーム

## 目次
1. [概要](#1-概要)
2. [技術仕様](#2-技術仕様)
3. [システムアーキテクチャ](#3-システムアーキテクチャ)
4. [機能仕様](#4-機能仕様)
5. [データ仕様](#5-データ仕様)
6. [UI/UX仕様](#6-uiux仕様)
7. [API連携仕様](#7-api連携仕様)
8. [エラーハンドリング](#8-エラーハンドリング)
9. [パフォーマンス・制約事項](#9-パフォーマンス制約事項)
10. [セキュリティ](#10-セキュリティ)

## 1. 概要

### 1.1 プロジェクト概要
**PointGPS**は、国土地理院地図上でGPSポイントの表示、編集、管理を行うWebアプリケーションです。Excelファイルからのデータ読み込み、ポイントの追加・移動・削除、GeoJSON形式での出力に対応しています。

### 1.2 主要機能
- 国土地理院地図上でのGPSポイント可視化
- ExcelファイルからのGPSデータ読み込み
- GeoJSONファイルの読み込み・出力
- インタラクティブなポイント編集（追加・移動・削除）
- 国土地理院標高APIを使用した自動標高取得
- レスポンシブデザインによるマルチデバイス対応

### 1.3 対象ユーザー
- 地理情報システム（GIS）利用者
- 測量・調査業務従事者
- 研究者・学生
- アウトドア活動愛好者

## 2. 技術仕様

### 2.1 技術スタック
- **フロントエンド**: Vanilla JavaScript (ES6 Modules)
- **地図ライブラリ**: Leaflet.js v1.9.4
- **ファイル処理**: SheetJS (XLSX) v0.18.5
- **スタイリング**: カスタムCSS
- **アーキテクチャ**: ES6モジュールベースのクラス指向設計

### 2.2 依存関係
#### 外部CDN
- Leaflet.js CSS/JS: v1.9.4 (unpkg.com)
- SheetJS: v0.18.5 (unpkg.com)

#### セキュリティ対策
- integrity属性による整合性検証
- crossorigin属性によるCORS制御

### 2.3 ブラウザ要件
- **最小要件**:
  - ES6 Modules対応ブラウザ
  - File System Access API（Chrome 86+推奨）
  - Fetch API対応
  - FileReader API対応
- **推奨環境**: Chrome 90+, Firefox 88+, Safari 14+

### 2.4 動作環境要件
- **ローカル開発**: HTTPサーバー必須（CORS制限のため）
- **サーバー**: 静的ファイル配信対応
- **インターネット接続**: CDN、地図タイル、標高API利用のため必要

## 3. システムアーキテクチャ

### 3.1 モジュール構成
```
js/
├── app.js               # メインアプリケーション制御
├── config.js            # 設定定数管理
├── map-manager.js       # Leaflet地図管理
├── gps-data-manager.js  # GPSデータCRUD操作
├── point-manager.js     # ポイント表示・編集制御
├── file-handler.js      # ファイル入出力処理
└── validators.js        # データ検証・フォーマット処理
```

### 3.2 クラス関係図
```
PointGPSApp (メインコントローラー)
├── MapManager (地図管理)
├── GPSDataManager (データ管理)
│   └── FileHandler (ファイル処理)
├── PointManager (ポイント操作)
│   ├── MapManager
│   └── GPSDataManager
└── Validators (データ検証)
```

### 3.3 初期化フロー
1. **DOMContentLoaded** → PointGPSApp初期化
2. **MapManager初期化** → Leaflet地図設定
3. **FileHandler初期化** → ファイル処理準備
4. **GPSDataManager初期化** → データ管理準備
5. **PointManager初期化** → UI操作準備
6. **イベントハンドラー設定** → ユーザーインタラクション準備

## 4. 機能仕様

### 4.1 地図表示機能

#### 4.1.1 基本設定
- **初期中心点**: 箕面大滝 (34.853667, 135.472041)
- **初期ズームレベル**: 15
- **地図タイル**: 国土地理院標準地図
- **コントロール**: ズーム（右下）、スケール（右下、メートル法のみ）

#### 4.1.2 操作機能
- **パン操作**: マウスドラッグ、タッチ操作
- **ズーム操作**: ホイール、ピンチ、ズームコントロール
- **クリックイベント**: ポイント追加時の位置指定

### 4.2 データ読み込み機能

#### 4.2.1 Excelファイル読み込み
- **対応形式**: `.xlsx`のみ
- **ヘッダー認識規則**:
  - ポイントID: "ポイント"を含む列名
  - 緯度: "緯度"完全一致
  - 経度: "経度"完全一致
  - 標高: "標高"完全一致
  - 場所名: "名称"/"位置"/"場所"を含む列名

#### 4.2.2 座標変換機能
- **DMS → 10進数変換**: 自動認識・変換
- **対応形式**: 
  - `35°30'45"N` → `35.5125`
  - `35度30分45秒N` → `35.5125`
- **エラー処理**: 不正データ行の自動スキップ

#### 4.2.3 GeoJSONファイル読み込み
- **対応形式**: `.geojson` (FeatureCollection)
- **座標配列**: [経度, 緯度, 標高(オプション)]
- **プロパティマッピング**:
  - `properties.id` → ポイントID
  - `properties.name` → 場所名

### 4.3 ポイント編集機能

#### 4.3.1 ポイント追加
- **操作フロー**: 「追加」ボタン → 地図クリック → ポイント生成
- **ID自動生成**: 仮01, 仮02... の連番システム
- **自動フォーカス**: 新規ポイントのIDフィールド自動選択・全選択
- **標高取得**: 国土地理院標高API自動実行

#### 4.3.2 ポイント移動
- **操作フロー**: 
  1. ポイント選択（クリック）
  2. 「移動」ボタンクリック
  3. ドラッグによる位置変更
  4. 自動的にモード解除
- **リアルタイム更新**: 移動中の緯度・経度・DMS座標動的表示
- **視覚フィードバック**: 移動ボタンのライムグリーン化
- **自動解除条件**:
  - ドラッグ完了時
  - 他のポイントクリック時
  - 他のボタン（追加・削除）クリック時
  - ESCキー押下時

#### 4.3.3 ポイント削除
- **操作フロー**: ポイント選択 → 「削除」ボタン → 確認ダイアログ → 実行
- **整合性保証**: マーカー・データ・UI表示の同期削除

### 4.4 ポイント情報管理

#### 4.4.1 情報表示フィールド
| フィールド | 編集可否 | 表示形式 | 制約・機能 |
|------------|----------|----------|------------|
| ポイントID | 編集可能 | テキスト | 5文字制限、バリデーション付き |
| 緯度 | 読み取り専用 | 10進数5桁 | 自動計算・表示 |
| 経度 | 読み取り専用 | 10進数5桁 | 自動計算・表示 |
| DMS | 読み取り専用 | 度分秒形式 | E/N方向表示付き |
| 標高 | 読み取り専用 | 整数 | 手動入力不可 |
| GPS標高 | 読み取り専用 | 整数 | API自動取得 |
| 場所名 | 編集可能 | テキスト | 20文字制限 |

#### 4.4.2 タブ順序制御
- **tabindex設定**:
  - ポイントID: `tabindex="1"`
  - 場所名: `tabindex="2"`
  - 読み取り専用フィールド: `tabindex="-1"`（タブ順序から除外）

#### 4.4.3 バリデーション機能
- **ポイントID正規化**:
  - 全角→半角変換
  - 英小文字→大文字変換
  - 数字1桁→0パディング（1 → 01）
  - 自動ハイフン挿入（X-nn形式）
  - 日本語文字は変換対象外

### 4.5 ファイル出力機能

#### 4.5.1 Excelファイル出力
- **ヘッダー行**: ID, 緯度, 経度, 標高, GPS標高, 場所
- **ファイル名**: `ポイントGPS-yyyymmdd.xlsx`
- **保存方式**: File System Access API優先、未対応時は自動ダウンロード

#### 4.5.2 GeoJSONファイル出力
- **形式**: FeatureCollection
- **座標配列**: [経度, 緯度, 標高]
- **標高優先順**: GPS標高 > 手動入力標高
- **プロパティ**: `{id, name}`
- **ファイル名**: `ポイントGPS-yyyymmdd.geojson`

## 5. データ仕様

### 5.1 内部データ構造
```javascript
// ポイントオブジェクト
{
  id: string,           // ポイントID
  lat: number,          // 緯度 (10進数)
  lng: number,          // 経度 (10進数)
  elevation: string,    // 標高 (文字列形式)
  gpsElevation: string, // GPS標高 (API取得値)
  location: string      // 場所名
}
```

### 5.2 設定定数 (CONFIG)
```javascript
{
  // 地図設定
  MAP_CENTER: [34.853667, 135.472041], // 箕面大滝
  MAP_ZOOM: 15,
  
  // マーカー色設定
  POINT_MARKER_COLOR: '#008000',        // 通常ポイント（緑）
  SELECTED_POINT_COLOR: '#32cd32',      // 選択ポイント（ライムグリーン）
  MOVE_BUTTON_ACTIVE_COLOR: '#32cd32',  // 移動ボタン活性時
  
  // UI設定
  MESSAGE_DISPLAY_DURATION: 3000,      // メッセージ表示時間（ms）
}
```

### 5.3 ファイル形式仕様

#### 5.3.1 Excel入力形式
```
| ポイント | 緯度      | 経度       | 標高 | 場所       |
|----------|-----------|------------|------|------------|
| P-01     | 34.853667 | 135.472041 | 150  | 箕面大滝   |
| P-02     | 34.854000 | 135.473000 | 145  | 展望台     |
```

#### 5.3.2 GeoJSON出力形式
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [135.472041, 34.853667, 150]
      },
      "properties": {
        "id": "P-01",
        "name": "箕面大滝"
      }
    }
  ]
}
```

## 6. UI/UX仕様

### 6.1 レイアウト設計
- **地図**: フルスクリーン背景
- **制御パネル**: 右上固定オーバーレイ（320px幅）
- **メッセージエリア**: 画面中央ポップアップ表示

### 6.2 レスポンシブデザイン
- **デスクトップ**: 1024px以上
- **タブレット**: 768px以上（制御パネル全幅表示）
- **モバイル**: 480px以下（レイアウト最適化）

### 6.3 カラーパレット
- **プライマリ**: #3498db（青）- 基本ボタン
- **セカンダリ**: #27ae60（緑）- アクションボタン
- **アクセント**: #e67e22（オレンジ）- エクスポートボタン
- **ポイント**: #008000（緑）- 通常マーカー
- **選択**: #32cd32（ライムグリーン）- 選択状態

### 6.4 インタラクション
- **ホバーエフェクト**: ボタン色変化、上昇効果
- **フォーカス表示**: 青色アウトライン（2px）
- **ローディング状態**: 透明度変更、スピナー表示
- **カーソル変更**: 追加モード（十字）、移動モード（移動）

### 6.5 アクセシビリティ対応
- **セマンティックHTML**: `role`、`aria-label`属性
- **キーボード操作**: ESCキーによるモード解除
- **スクリーンリーダー**: 隠しテキストによる説明
- **フォーカス管理**: 論理的なタブ順序

## 7. API連携仕様

### 7.1 国土地理院標高API

#### 7.1.1 基本仕様
- **エンドポイント**: `https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php`
- **メソッド**: GET
- **パラメータ**: 
  - `lon`: 経度（10進数）
  - `lat`: 緯度（10進数）
  - `outtype`: 出力形式（JSON）

#### 7.1.2 リクエスト例
```
GET https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php?lon=135.472041&lat=34.853667&outtype=JSON
```

#### 7.1.3 レスポンス仕様
```json
{
  "elevation": 150.25,
  "hsrc": "5m（レーザ）"
}
```

#### 7.1.4 データ処理
- **数値丸め**: 四捨五入による整数変換
- **null値処理**: API障害時の警告ログ出力
- **自動実行タイミング**: ポイント選択時、移動完了時

## 8. エラーハンドリング

### 8.1 ファイル処理エラー

#### 8.1.1 読み込みエラー
- **不正ファイル形式**: MIME type検証、拡張子チェック
- **破損ファイル**: SheetJS例外キャッチ、警告表示
- **ユーザーキャンセル**: FileReader abort処理

#### 8.1.2 データ検証エラー
- **座標値範囲**: 緯度 [-90, 90]、経度 [-180, 180]
- **空行処理**: 自動スキップ、警告ログ出力
- **DMS変換失敗**: 元データ保持、手動修正促進

### 8.2 API通信エラー
- **標高API障害**: console.warn出力、処理継続
- **タイムアウト**: デフォルト値設定、再試行なし
- **CORS エラー**: ローカルサーバー実行指示

### 8.3 ユーザー操作エラー
- **未選択操作**: アクション無効化、警告メッセージ
- **重複ID**: 自動連番による回避
- **不正入力**: バリデーション自動修正

## 9. パフォーマンス・制約事項

### 9.1 制約事項

#### 9.1.1 技術制約
- **CORS制限**: `file://`プロトコル不可、HTTPサーバー必須
- **ブラウザ依存**: File System Access API未対応時はダウンロード方式
- **同期処理**: 大量データ読み込み時のUI ブロッキング

#### 9.1.2 データ制約
- **ポイント数**: ブラウザメモリ依存（実用上1000点程度推奨）
- **ファイルサイズ**: Excel 10MB、GeoJSON 5MB程度推奨
- **座標精度**: 10進数5桁（約1m精度）

### 9.2 パフォーマンス最適化

#### 9.2.1 読み込み最適化
- **CDN事前接続**: `rel="preconnect"`による高速化
- **整合性検証**: セキュリティと高速化の両立
- **非同期処理**: Promise/async-awaitによる処理分散

#### 9.2.2 メモリ最適化
- **マーカー管理**: Map構造による高速検索
- **イベント管理**: 適切なリスナー追加・削除
- **DOM操作**: 最小限のDOM変更

## 10. セキュリティ

### 10.1 実装済み対策

#### 10.1.1 コンテンツセキュリティ
- **HTTPヘッダー**: `X-Content-Type-Options: nosniff`
- **CDN検証**: integrity + crossorigin属性
- **XSS対策**: `innerHTML`回避、`textContent`使用

#### 10.1.2 入力検証
- **ファイル検証**: MIME type、拡張子チェック
- **データ検証**: 座標値範囲、文字列長制限
- **サニタイゼーション**: 特殊文字の無害化

### 10.2 セキュリティ考慮事項

#### 10.2.1 データ処理
- **ローカル処理**: サーバーサイド処理なし
- **一時データ**: ブラウザメモリのみ、永続化なし
- **外部通信**: 地図タイル、標高API（HTTPS）のみ

#### 10.2.2 プライバシー保護
- **位置情報**: ユーザー明示的入力のみ
- **データ送信**: 外部サーバーへの機密データ送信なし
- **クッキー**: 使用なし

---

## 更新履歴

| バージョン | 日付 | 更新内容 |
|------------|------|----------|
| v2.0 | 2024-09-06 | タブ順序制御、テキスト全選択機能、色設定統一、標高フィールド読み取り専用化 |
| v1.5 | 2024-09-05 | リアルタイム座標更新、移動モード改善 |
| v1.0 | 2024-09-01 | 初版リリース |

---

**© 2024 PointGPS Development Team. All rights reserved.**