# PointGPS 機能仕様書

**バージョン**: v1.0  
**更新日**: 2025年 9月 9日

## 1. 概要

PointGPSは、国土地理院地図上でGPSポイントの表示、編集、管理を行うWebアプリケーションです。Excel専用のファイル処理、ポイントの追加・移動・削除、リアルタイム編集機能を提供します。

### 1.1 主要機能
- **Excel専用ファイル処理**: .xlsx形式のみ対応（GeoJSON廃止）
- **地図上ポイント管理**: 追加、選択、移動、削除
- **リアルタイム編集**: ドラッグによる位置変更
- **標高自動取得**: 国土地理院標高API連携（最適化済み）
- **レスポンシブUI**: デスクトップ・タブレット・モバイル対応

### 1.2 対象ユーザー
- 地理情報システム（GIS）利用者
- 測量・調査業務従事者
- 研究者・学生
- アウトドア活動愛好者

## 2. システム構成

### 2.1 技術スタック
- **フロントエンド**: Vanilla JavaScript (ES6 Modules)
- **地図ライブラリ**: Leaflet.js v1.9.4
- **ファイル処理**: SheetJS v0.18.5
- **外部API**: 国土地理院標高API

### 2.2 モジュール構成
```
js/
├── app.js              # メインアプリケーション
├── config.js           # 設定定数
├── map-manager.js      # 地図管理
├── gps-data-manager.js # GPSデータ管理
├── point-manager.js    # ポイント表示・編集管理
├── file-handler.js     # ファイル入出力処理
└── validators.js       # データ検証・フォーマット処理
```

### 2.3 ブラウザ要件
- **推奨**: Chrome 90+, Edge 90+, Firefox 88+, Safari 14+
- **必須技術**: ES6 Modules, Fetch API, FileReader API
- **File System Access API**: Chrome/Edge対応（保存場所選択）

## 3. データ仕様

### 3.1 内部ポイントデータ構造
```javascript
{
  id: string,           // ポイントID（必須）
  lat: number,          // 緯度 10進数形式（必須）
  lng: number,          // 経度 10進数形式（必須）
  elevation: string,    // 標高（任意、小数点1位まで）
  location: string,     // 名称（必須）
  remarks: string       // 備考（任意）
}
```

### 3.2 Excel仕様

#### 3.2.1 入力形式（厳密仕様）
- **対応形式**: .xlsx のみ
- **列名**: 完全一致必須

| 列名 | データ型 | 必須/任意 | 説明 |
|------|----------|-----------|------|
| ポイントID | string | 必須 | ポイント識別子 |
| 名称 | string | 必須 | ポイントの名前 |
| 緯度 | number | 必須 | 10進数形式またはDMS形式 |
| 経度 | number | 必須 | 10進数形式またはDMS形式 |
| 標高 | number | 任意 | メートル単位、小数点1位まで |
| 備考 | string | 任意 | メモやコメント |

#### 3.2.2 データ検証
- **必須項目チェック**: ポイントID、名称、緯度、経度が空でないこと
- **行レベルスキップ**: 必須項目欠けの行は読み込み対象外
- **座標変換**: DMS形式を10進数に自動変換

#### 3.2.3 出力形式
- **ファイル拡張子**: .xlsx
- **シート名**: "ポイントGPS"
- **列幅**: 内容に応じて自動調整
- **緯度・経度**: 小数点以下5桁まで（6桁を四捨五入）
- **標高**: 小数点1位まで（123.0は123として出力）

## 4. 機能詳細

### 4.1 地図表示機能

#### 4.1.1 基本設定
- **初期中心点**: 箕面大滝 (34.853667, 135.472041)
- **初期ズームレベル**: 15
- **地図タイル**: 国土地理院標準地図
- **コントロール**: ズーム（右下）、スケール（右下、メートル法のみ）

### 4.2 ファイル入出力

#### 4.2.1 Excel読み込み
**処理フロー**:
```javascript
app.js → gps-data-manager.js → file-handler.js → SheetJS
```

**処理ステップ**:
1. ファイル選択（.xlsxのみ受付）
2. FileReader APIによるバイナリ読み取り
3. SheetJSによるExcel解析
4. 列名完全一致検証
5. 必須項目存在チェック
6. データ行ごとの検証・変換
7. 内部データ構造への変換

#### 4.2.2 Excel出力
**処理ステップ**:
1. 内部データをExcel形式に変換
2. 座標精度調整（緯度経度5桁、標高1桁）
3. ワークブック作成（シート名: ポイントGPS）
4. 列幅自動調整
5. ファイル保存（File System Access API優先）

### 4.3 ポイント管理

#### 4.3.1 ポイント表示
- **マーカー**: 円形マーカー（半径6px、緑色）
- **選択表示**: ライムグリーン色に変更
- **ツールチップ**: ポイントIDを表示

#### 4.3.2 ポイント追加
**操作フロー**:
1. 「追加」ボタンクリック
2. 地図上クリックで座標指定
3. 自動ID生成（仮01, 仮02...）
4. 標高API自動取得（blank/0の場合のみ）
5. ポイント情報パネルに表示
6. ポイントIDフィールド自動フォーカス

#### 4.3.3 ポイント移動
**操作フロー**:
1. ポイント選択
2. 「移動」ボタンクリック
3. ドラッグによる位置変更
4. リアルタイム座標更新
5. ドラッグ完了時に標高API再取得
6. 移動モード自動解除

#### 4.3.4 ポイント削除
**操作フロー**:
1. ポイント選択
2. 「削除」ボタンクリック
3. 確認ダイアログ表示
4. 承認でポイント削除

### 4.4 ポイント情報編集

#### 4.4.1 フィールド構成（新配置）
| 順序 | フィールド | 編集可否 | タブ順序 | 機能 |
|------|------------|----------|----------|------|
| 1 | ポイントID | 可 | 1 | 自動フォーマット機能付き |
| 2 | 名称 | 可 | 2 | 任意テキスト入力 |
| 3 | 緯度 | 不可 | - | リアルタイム更新表示 |
| 4 | 経度 | 不可 | - | リアルタイム更新表示 |
| 5 | DMS | 不可 | - | 度分秒形式自動変換表示 |
| 6 | 標高 | 不可 | - | API取得値表示 |
| 7 | 備考 | 可 | 3 | 任意テキスト入力 |

#### 4.4.2 自動フォーマット機能
**ポイントID正規化**:
- 全角→半角変換
- 英字大文字化
- 数値部分の0パディング
- ハイフン挿入（例：p1 → P-01）

### 4.5 標高取得機能（最適化済み）

#### 4.5.1 API取得タイミング（限定的）
**取得するケース**:
1. 選択ポイントの標高がblankまたは0の場合のみ
2. 新規ポイント追加時
3. ポイント移動完了時

**取得しないケース**:
- **Excel読み込み時**（高速化のため削除）
- 標高に正の値がある場合

#### 4.5.2 国土地理院標高API連携
```javascript
// APIエンドポイント
https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php
```

**仕様**:
- **データソース**: 5mメッシュ、レーザー測量データ
- **精度**: 小数点1位まで（123.0は123として表示）
- **エラー処理**: 取得失敗時は警告ログ、処理継続

### 4.6 UI/UX機能

#### 4.6.1 リアルタイム更新
- **移動中座標表示**: mousemoveイベント同期
- **高頻度更新**: ドラッグ中の緯度・経度・DMS
- **視覚フィードバック**: マーカー色変化、カーソル変化

#### 4.6.2 モード管理
- **追加モード**: 十字カーソル、地図クリックで追加
- **移動モード**: 移動カーソル、ドラッグで位置変更
- **ESCキー**: 全モード解除

## 5. レスポンシブデザイン

### 5.1 ブレークポイント
- **デスクトップ**: 1024px以上（右側固定パネル）
- **タブレット**: 768px-1023px（全幅パネル）
- **モバイル**: 767px以下（最適化レイアウト）

## 6. パフォーマンス（大幅改善）

### 6.1 最適化効果
- **Excel読み込み**: 約30-50倍高速化（標高API削除）
- **処理時間**: 100ポイント約300-500ms
- **ユーザー体験**: 即座に読み込み完了

### 6.2 処理時間（参考値）
- **Excel読み込み**: 100ポイント約300-500ms（大幅短縮）
- **ポイント追加**: 約200-400ms（標高取得含む）
- **ポイント移動**: 約300-500ms（標高再取得含む）

## 7. セキュリティ・品質

### 7.1 セキュリティ対策
- **CDN整合性検証**: integrity + crossorigin属性
- **XSS対策**: innerHTML回避、textContent使用
- **CSRF対策**: ローカル処理のみ、外部送信なし
- **ファイル検証**: MIME type、拡張子チェック

### 7.2 エラーハンドリング
- **ファイル読み込みエラー**: 適切なエラーメッセージ
- **API通信障害**: 警告ログ出力、処理継続
- **データ検証エラー**: 自動修正またはスキップ

## 8. 制約事項

### 8.1 技術制約
- **CORS制限**: file://プロトコル不可、HTTPサーバー必須
- **座標系**: WGS84のみ対応
- **ファイル形式**: .xlsxのみ（GeoJSON廃止）

### 8.2 運用制約
- **インターネット接続**: 地図タイル、標高API利用のため必要
- **メモリ制限**: 1000ポイント超で性能劣化の可能性
- **データ永続化**: ブラウザ一時メモリのみ

## 9. 更新履歴

### v1.0 (2025-09-09)
- 新規バージョン作成

---

**Document Version**: 1.0  
**Last Updated**: 2025年 9月 9日  
**© 2025 PointGPS Development Team. All rights reserved.**