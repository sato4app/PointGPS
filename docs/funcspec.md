# PointGPS アプリケーション機能仕様書

**バージョン**: v2.3
**作成日**: 2024年12月21日
**対象**: 開発者・テスター向け技術仕様

## 1. 概要

PointGPSは、国土地理院地図上でGPSポイントの表示、編集、管理を行うWebアプリケーションです。v2.3ではリファクタリングによる保守性向上と動的メッセージ機能を実現し、Excel専用化により大幅高速化を継続しています。

### 主要特徴
- Excel専用化による30-50倍高速化（v2.2～）
- 動的ポイントIDメッセージ表示（v2.3）
- リファクタリングによる保守性向上（v2.3）
- 厳密なデータ検証とフォーマット機能
- リアルタイムポイント移動とGPS標高取得
- レスポンシブデザイン対応

## 2. 基本機能

### 2.1 データ読み込み機能

#### Excel読み込み（専用機能）
- **対応形式**: Excel (.xlsx)のみ
- **読み込み制限**: 最大1000行（CONFIG.MAX_EXCEL_ROWS）
- **高速処理**: SheetJSレベルでの効率的行数制限
- **処理時間**: 100ポイント約300-500ms（従来の30-50倍高速）

#### 列構成・データ検証
**必須項目（完全一致判定）**:
- `ポイントID`: 識別子
- `名称`: 地点名称
- `緯度`: 座標（10進数またはDMS）
- `経度`: 座標（10進数またはDMS）

**任意項目**:
- `標高`: 高度情報（メートル）
- `備考`: 追加情報

#### データ処理・検証
- **座標変換**: DMS（度分秒）→10進数の自動変換
- **データ検証**: 必須項目欠け行の自動スキップ
- **座標範囲チェック**: 緯度±90度、経度±180度
- **空行除外**: 全セル空白行の自動スキップ
- **エラーハンドリング**: 無効データの警告とスキップ

### 2.2 ポイント管理機能

#### ポイント追加
```
操作フロー: 追加ボタン → 地図クリック → ポイント生成
```
- **自動ID生成**: 「仮01」「仮02」...の連番
- **GPS標高取得**: 国土地理院標高API自動呼び出し
- **UI自動化**: ポイントIDフィールドのフォーカス・全選択
- **メッセージ**: 「ポイント 仮01 を追加しました」（動的表示）

#### ポイント移動
```
操作フロー: ポイント選択 → 移動ボタン → ドラッグ操作
```
- **リアルタイム更新**: ドラッグ中の座標情報動的表示
- **ビジュアル**: ボタン色変化（ライムグリーン #32cd32）
- **標高再取得**: ドラッグ完了時の自動標高更新
- **自動解除**: ESCキー、ドラッグ完了、他操作時
- **メッセージ**: 「ポイント A-02 を移動しました」（動的表示）

#### ポイント削除
```
操作フロー: ポイント選択 → 削除ボタン → 確認ダイアログ → 削除実行
```
- **安全削除**: 確認ダイアログによる誤操作防止
- **完全削除**: マーカーとデータの同期削除
- **メッセージ**: 「ポイント A-02 を削除しました」（動的表示）

#### ポイント選択・表示
- **選択方法**: マーカークリックまたはリスト選択
- **ビジュアル**: 色変化（緑 #008000 → ライムグリーン #32cd32）
- **情報更新**: 選択時の詳細情報表示エリア更新

### 2.3 地図表示・操作機能

#### 地図エンジン・設定
- **ライブラリ**: Leaflet.js v1.9.4
- **タイル**: 国土地理院標準地図
- **初期位置**: 箕面大滝 [34.853667, 135.472041]
- **初期ズーム**: 15レベル
- **コントロール**: ズーム（右下）、スケール（右下、メートル法）

#### マーカー仕様
- **タイプ**: CircleMarker
- **半径**: 6px
- **通常色**: 緑 (#008000)
- **選択色**: ライムグリーン (#32cd32)
- **z-index制御**: 選択マーカーの最前面表示

### 2.4 ファイル出力機能

#### Excel出力（専用機能）
- **出力形式**: Excel (.xlsx)のみ
- **シート名**: 「ポイントGPS」
- **座標精度**: 緯度・経度は小数点以下5桁
- **標高表示**: 小数点1位まで、123.0→123として最適化
- **列幅**: 日本語対応の自動調整

#### 保存方式
- **優先**: File System Access API（対応ブラウザ）
- **フォールバック**: 自動ダウンロード（非対応ブラウザ）
- **デフォルトファイル名**: 「ポイントGPS-yyyymmdd.xlsx」
- **ディレクトリ記憶**: 前回保存場所の記憶機能

## 3. UI/UX機能

### 3.1 動的メッセージ表示（v2.3新機能）

#### テンプレート機能
```javascript
// 設定例
POINT_ADDED: 'ポイント {id} を追加しました'
POINT_MOVED: 'ポイント {id} を移動しました'
POINT_DELETED: 'ポイント {id} を削除しました'

// 動的表示例
'ポイント A-02 を追加しました'
'ポイント 仮01 をドラッグして移動してください'
```

#### メッセージタイプ・表示時間
- **info**: 3秒表示（通常メッセージ）
- **warning**: 4.5秒表示（1.5倍、制限到達等）
- **error**: 6秒表示（2倍、エラー情報）

#### 表示位置・スタイル
- **位置**: 画面中央オーバーレイ
- **スタイル**: 背景色によるタイプ識別
- **アニメーション**: フェードイン・アウト

### 3.2 フォーム・フィールド機能

#### ポイントID自動フォーマット
```javascript
// 変換例
'p1' → 'P-01'          // 大文字化・0パディング・ハイフン挿入
'Ａ１' → 'A-01'         // 全角→半角変換
'箕面１' → '箕面1'      // 全角数字のみ半角（漢字保持）
```

**変換ルール**:
- 全角英数字→半角変換、英文字大文字化
- 1桁数字の0パディング
- 3文字以内での自動ハイフン挿入
- 日本語文字の保持
- blur時の自動修正とメッセージ表示

#### フィールド構成・配置（v2.3最適化）
```
ポイントID    [編集可能, tabindex=1, 自動フォーマット]
名称         [編集可能, tabindex=2]
緯度         [読み取り専用, リアルタイム更新]
経度         [読み取り専用, リアルタイム更新]
DMS         [読み取り専用, E/N付き東経・北緯順]
標高         [読み取り専用, 小数点1位まで]
備考         [編集可能, tabindex=3, v2.3新規追加]
```

### 3.3 キーボード操作・アクセシビリティ

#### タブ順序制御（v2.3最適化）
- **編集可能フィールド**: ポイントID → 名称 → 備考
- **読み取り専用フィールド**: tabindex="-1"でスキップ
- **論理的タブ順序**: 入力効率を最優先

#### キーボードショートカット
- **ESC**: 全モード終了（追加・移動・編集）
- **Tab/Shift+Tab**: フィールド間移動
- **Enter**: フォーム確定・次フィールド移動

#### アクセシビリティ対応
- **セマンティックHTML**: role、aria-label属性
- **スクリーンリーダー**: .visually-hiddenクラスによる支援
- **フォーカス管理**: 視覚的インジケータ
- **高コントラスト**: 色覚対応配色

### 3.4 レスポンシブデザイン

#### ブレークポイント設計
```css
/* デスクトップ */
@media (min-width: 1024px) {
    /* 右側固定パネル320px */
}

/* タブレット */
@media (768px <= width < 1024px) {
    /* 全幅パネル */
}

/* モバイル */
@media (max-width: 767px) {
    /* 縦積みレイアウト */
}
```

#### タッチ操作対応
- **ピンチズーム**: 地図の拡大・縮小
- **タップ**: ポイント選択・マーカー操作
- **ドラッグ**: ポイント移動（タッチデバイス）
- **ボタンサイズ**: 44px以上のタッチターゲット

## 4. データ処理機能

### 4.1 座標変換機能（DataUtils）

#### DMS ⇔ 10進数変換
```javascript
// DMS → 10進数
'34°51\'13.2"' → 34.853667
'135°28\'19.3"' → 135.472041

// 10進数 → DMS（表示用）
34.853667 → '東経135°28\'19.3"'
135.472041 → '北緯34°51\'13.2"'
```

#### 方向付きDMS表示
- **経度**: 東経（E）・西経（W）
- **緯度**: 北緯（N）・南緯（S）
- **表示順**: 東経・北緯順での統一表示

### 4.2 標高取得機能（ElevationAPI v2.3分離）

#### 国土地理院標高API連携
- **データソース**: 5mメッシュ、レーザー測量データ
- **API URL**: `https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php`
- **パラメータ**: `lon={lng}&lat={lat}&outtype=JSON`

#### 取得タイミング（最適化済み）
```javascript
// 取得する場合
- 新規ポイント追加時
- ポイント選択時（標高がblankまたは0の場合のみ）
- ポイント移動完了時

// 取得しない場合（高速化）
- Excel読み込み時（大幅高速化のため）
- 既に有効な標高値がある場合
```

#### 標高値処理
- **正規化**: 小数点1位まで表示
- **整数表示**: 123.0 → 123として最適化
- **エラーハンドリング**: 取得失敗時の警告ログ

### 4.3 データ検証・正規化（DataUtils v2.3統合）

#### バリデーション機能
```javascript
// セル値安全取得
DataUtils.getCellValue(row, index)

// 空行判定
DataUtils.isEmptyRow(row)

// 座標値検証
DataUtils.parseLatLng(value)
```

#### データ正規化
- **ポイントID**: formatPointId()による自動修正
- **標高値**: normalizeElevation()による統一フォーマット
- **文字列処理**: トリム、null/undefined対応

## 5. 技術仕様

### 5.1 アーキテクチャ（v2.3リファクタリング後）

#### モジュール構成
```
js/
├── app.js              # メインアプリケーション統合
├── config.js           # 設定定数・メッセージ定義
├── map-manager.js      # Leaflet地図管理
├── gps-data-manager.js # データ管理・Excel処理
├── point-manager.js    # ポイント表示・編集・UI
├── file-handler.js     # ファイル入出力・保存処理
├── data-utils.js       # データ処理ユーティリティ（v2.3分離）
└── elevation-api.js    # 標高API連携（v2.3分離）
```

#### クラス設計・依存関係
```
PointGPSApp
├── MapManager (Leaflet管理)
├── FileHandler (Excel入出力)
├── GPSDataManager (データ管理)
│   ├── DataUtils (データ処理)
│   └── ElevationAPI (標高取得)
└── PointManager (UI・表示制御)
    ├── DataUtils (フォーマット)
    └── ElevationAPI (標高取得)
```

### 5.2 制限事項・前提条件

#### 技術制約
- **CORS制限**: file://プロトコル不可、HTTPサーバー必須
- **座標系**: WGS84のみ対応（日本測地系非対応）
- **Excel形式**: .xlsxのみ対応（.xls/.csv/.txt非対応）
- **読み込み行数**: 最大1000行（設定変更可能）

#### 運用制約
- **インターネット接続**: 地図タイル・標高API利用必須
- **メモリ使用量**: 大量ポイント（1000点以上）で性能劣化可能性
- **データ永続化**: ブラウザセッション内のみ、定期エクスポート推奨

### 5.3 パフォーマンス仕様

#### 処理速度（v2.2以降大幅改善）
```
Excel読み込み処理時間:
- 100ポイント: 約300-500ms（従来10-15秒の30-50倍高速）
- 500ポイント: 約1-2秒
- 1000ポイント: 約3-5秒
```

#### 最適化技術
- **SheetJSレベル制限**: ワークシート範囲での効率的行数制限
- **標高API削除**: Excel読み込み時のAPI呼び出し削除
- **非同期処理**: Promise/async-awaitによるUI応答性確保
- **CDN事前接続**: rel="preconnect"によるリソース読み込み高速化

### 5.4 ブラウザ対応・互換性

#### 推奨環境
```
デスクトップ:
- Chrome 90+ (推奨)
- Firefox 88+
- Safari 14+
- Edge 90+

モバイル:
- iOS Safari 14+
- Chrome Android 90+
```

#### 必須Web API
- **ES6 Modules**: import/exportサポート
- **Fetch API**: HTTP通信
- **FileReader API**: ローカルファイル読み込み
- **Web Storage API**: 設定保存

#### 条件付きサポート
- **File System Access API**: 対応ブラウザでの高度ファイル保存
- **Touch Events**: タッチデバイスでの操作

### 5.5 外部依存関係・CDN

#### 主要ライブラリ
```html
<!-- Leaflet.js v1.9.4 -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<!-- SheetJS v0.18.5 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
```

#### 外部API
```javascript
// 国土地理院地図タイル
https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png

// 国土地理院標高API
https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php
```

## 6. テスト仕様

### 6.1 機能テスト項目

#### データ読み込みテスト
- [ ] Excel(.xlsx)ファイルの正常読み込み
- [ ] 1000行制限の動作確認
- [ ] 必須項目欠けデータのスキップ
- [ ] DMS座標の10進数変換
- [ ] 無効ファイル形式の適切なエラー処理

#### ポイント操作テスト
- [ ] ポイント追加・ID自動生成
- [ ] ドラッグによるポイント移動
- [ ] ポイント削除・確認ダイアログ
- [ ] 標高の自動取得・表示
- [ ] 動的メッセージ表示（ポイントID含有）

#### UI/UXテスト
- [ ] ポイントIDの自動フォーマット
- [ ] タブ順序・キーボード操作
- [ ] レスポンシブデザイン（各画面サイズ）
- [ ] エラーメッセージの適切な表示

#### ファイル出力テスト
- [ ] Excel形式での正常出力
- [ ] 座標精度・フォーマットの確認
- [ ] File System Access APIとフォールバック動作

### 6.2 パフォーマンステスト

#### 処理時間測定
- [ ] 100ポイントExcel読み込み: 500ms以内
- [ ] 500ポイントExcel読み込み: 2秒以内
- [ ] 1000ポイントExcel読み込み: 5秒以内
- [ ] UI応答性: 操作後100ms以内の反応

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| v1.0 | 2025-09-12 | 初版作成 |

**ドキュメント作成者**: Claude Code
**最終更新**: 2025年9月12日